# Tasks: Enhanced Article Outline Generator with Interim Classification

**Input**: Design documents from `/specs/012-the-changes-are/`
**Prerequisites**: plan.md (required), research.md, data-model.md, contracts/, quickstart.md

## Execution Flow (main)
```
1. Load plan.md from feature directory
   → Tech stack: Python 3.11+, pydantic>=2.0, pydantic-ai
   → Structure: Single-file agent enhancement
   → Libraries: Existing dependencies preserved
2. Load design documents:
   → data-model.md: Enhanced models with classification fields
   → contracts/: 3 schema files (input, output, envelope)
   → research.md: PydanticAI integration patterns
   → quickstart.md: 8 validation scenarios
3. Generate tasks by category:
   → Setup: Agent backup, dependencies, environment
   → Tests: Schema validation, contract tests, integration tests
   → Core: Model enhancement, PydanticAI integration, classification logic
   → Integration: CLI updates, logging enhancement, cost tracking
   → Polish: Golden tests, performance validation, documentation
4. Apply task rules:
   → Schema tests = [P] (different contract files)
   → Model enhancements = [P] (independent sections)
   → Main agent file = sequential (same file modifications)
5. Tests before implementation (TDD approach)
6. Constitutional compliance throughout
```

## Format: `[ID] [P?] Description`
- **[P]**: Can run in parallel (different files, no dependencies)
- Include exact file paths in descriptions

## Path Conventions
- **Agent Structure**: `agents/article_outline_generator/` (existing single-file pattern)
- **Main Agent**: `agents/article_outline_generator/article_outline_generator.py`
- **Tests**: `agents/article_outline_generator/tests/` (existing structure)
- **Schemas**: `agents/article_outline_generator/schemas/` (generated by CI)

## Phase 3.1: Setup & Preparation
- [ ] T001 Backup existing agent file for safety and rollback capability
- [ ] T002 [P] Verify pydantic-ai dependency availability in pyproject.toml
- [ ] T003 [P] Create environment variables for testing (OPENAI_API_KEY, etc.)

## Phase 3.2: Contract Tests First (TDD) ⚠️ MUST COMPLETE BEFORE 3.3
**CRITICAL: These tests MUST be written and MUST FAIL before ANY implementation**
- [ ] T004 [P] Contract test enhanced input schema in agents/article_outline_generator/tests/contract/test_input_schema.py
- [ ] T005 [P] Contract test enhanced output schema in agents/article_outline_generator/tests/contract/test_output_schema.py
- [ ] T006 [P] Contract test enhanced envelope schema in agents/article_outline_generator/tests/contract/test_envelope_schema.py
- [ ] T007 [P] Integration test backward compatibility in agents/article_outline_generator/tests/integration/test_backward_compatibility.py
- [ ] T008 [P] Integration test LLM enhancement in agents/article_outline_generator/tests/integration/test_llm_enhancement.py
- [ ] T009 [P] Integration test interim classification in agents/article_outline_generator/tests/integration/test_interim_classification.py
- [ ] T010 [P] Integration test graceful degradation in agents/article_outline_generator/tests/integration/test_graceful_degradation.py

## Phase 3.3: Core Model Enhancement (ONLY after tests are failing)
- [ ] T011 [P] Enhance InputModel with interim classification fields in agents/article_outline_generator/article_outline_generator.py (lines ~120-140)
- [ ] T012 [P] Enhance OutlineMetadata with classification details in agents/article_outline_generator/article_outline_generator.py (lines ~143-151)
- [ ] T013 [P] Add LLMClassificationResult model in agents/article_outline_generator/article_outline_generator.py (after line 205)
- [ ] T014 [P] Add ClassificationPrompt model in agents/article_outline_generator/article_outline_generator.py (after LLMClassificationResult)
- [ ] T015 [P] Enhance EnvelopeMeta with classification metadata in agents/article_outline_generator/article_outline_generator.py (lines ~185-198)

## Phase 3.4: PydanticAI Integration
- [ ] T016 Import PydanticAI with conditional fallback in agents/article_outline_generator/article_outline_generator.py (line ~73)
- [ ] T017 Enhance ModelConfig with PydanticAI settings in agents/article_outline_generator/article_outline_generator.py (lines ~79-93)
- [ ] T018 Create PydanticAI agent factory function in agents/article_outline_generator/article_outline_generator.py (after line 250)
- [ ] T019 Replace enhance_with_llm stub with full implementation in agents/article_outline_generator/article_outline_generator.py (lines ~479-494)

## Phase 3.5: Classification Enhancement Logic
- [ ] T020 Add cost calculation utilities in agents/article_outline_generator/article_outline_generator.py (after PydanticAI agent factory)
- [ ] T021 Enhance classification confidence evaluation in process_content function (line ~579)
- [ ] T022 Add interim classification support to process_content function
- [ ] T023 Update envelope cost tracking with LLM usage data (lines ~600-608)

## Phase 3.6: CLI and Observability Enhancement
- [ ] T024 Enhance configuration loading with environment variable precedence (lines ~200-250)
- [ ] T025 Add structured logging events for model calls (extend existing log_event function)
- [ ] T026 Update selfcheck command to validate LLM configuration
- [ ] T027 Update print-schemas command to include enhanced schemas

## Phase 3.7: Golden Tests & Performance Validation
- [ ] T028 [P] Golden test for backward compatibility scenario in agents/article_outline_generator/tests/golden/test_backward_compatibility.py
- [ ] T029 [P] Golden test for enhanced classification scenario in agents/article_outline_generator/tests/golden/test_enhanced_classification.py
- [ ] T030 [P] Golden test for story classification with LLM in agents/article_outline_generator/tests/golden/test_story_classification.py
- [ ] T031 [P] Performance test for constitutional budget compliance in agents/article_outline_generator/tests/integration/test_performance_budgets.py
- [ ] T032 Validate all quickstart scenarios pass end-to-end

## Phase 3.8: Documentation & Polish
- [ ] T033 [P] Update agent docstring with enhanced capabilities in agents/article_outline_generator/article_outline_generator.py (lines 1-57)
- [ ] T034 [P] Update constitutional compliance verification
- [ ] T035 [P] Run linting and formatting (ruff, black, mypy --strict)
- [ ] T036 Generate final schemas to agents/article_outline_generator/schemas/ for CI validation

## Dependencies
- Setup (T001-T003) before all other phases
- Contract tests (T004-T010) before implementation (T011-T027)
- Model enhancements (T011-T015) before PydanticAI integration (T016-T019)
- PydanticAI integration (T016-T019) before classification logic (T020-T023)
- Core implementation (T011-T023) before CLI enhancements (T024-T027)
- Implementation before validation (T028-T032)
- All implementation before documentation (T033-T036)

## Parallel Execution Examples

### Contract Tests (Can run simultaneously):
```bash
# Launch T004-T010 together:
Task: "Contract test enhanced input schema in agents/article_outline_generator/tests/contract/test_input_schema.py"
Task: "Contract test enhanced output schema in agents/article_outline_generator/tests/contract/test_output_schema.py"
Task: "Contract test enhanced envelope schema in agents/article_outline_generator/tests/contract/test_envelope_schema.py"
Task: "Integration test backward compatibility in agents/article_outline_generator/tests/integration/test_backward_compatibility.py"
```

### Model Enhancements (Independent Pydantic model sections):
```bash
# Launch T011-T015 together:
Task: "Enhance InputModel with interim classification fields in agents/article_outline_generator/article_outline_generator.py (lines ~120-140)"
Task: "Enhance OutlineMetadata with classification details in agents/article_outline_generator/article_outline_generator.py (lines ~143-151)"
Task: "Add LLMClassificationResult model in agents/article_outline_generator/article_outline_generator.py (after line 205)"
```

### Golden Tests (Independent test files):
```bash
# Launch T028-T031 together:
Task: "Golden test for backward compatibility scenario in agents/article_outline_generator/tests/golden/test_backward_compatibility.py"
Task: "Golden test for enhanced classification scenario in agents/article_outline_generator/tests/golden/test_enhanced_classification.py"
Task: "Performance test for constitutional budget compliance in agents/article_outline_generator/tests/integration/test_performance_budgets.py"
```

## Validation Scenarios (From quickstart.md)
Each integration test task corresponds to a quickstart scenario:
- T007: Scenario 1 (Backward Compatibility)
- T008: Scenario 2 (Enhanced Classification)
- T009: Scenario 3 (Interim Classification)
- T008: Scenario 4 (Story Classification)
- T010: Scenario 5 (Graceful Degradation)
- T007: Scenario 6 (Error Handling)
- T031: Scenario 7 (Performance Budget)
- T026: Scenario 8 (Schema Validation)

## Constitutional Compliance Checkpoints
- T015: Envelope metadata follows Article II requirements
- T019: LLM calls follow Article X (STRICT default, fallback only)
- T025: Structured logging follows Article XVIII
- T026: CLI compliance with Article XX
- T034: Final constitutional verification

## Notes
- [P] tasks = different files or independent code sections
- Main agent file modifications are sequential to avoid conflicts
- Verify tests fail before implementing each feature
- Commit after each completed task for rollback safety
- All enhancements maintain backward compatibility
- Performance budgets enforced throughout: <5s runtime, <2 LLM calls, <2000 tokens

## Task Generation Rules Applied
1. **From Contracts**: 3 schema files → 3 contract test tasks [P]
2. **From Data Model**: 5 enhanced entities → 5 model enhancement tasks [P]
3. **From Quickstart**: 8 scenarios → 4 integration test tasks [P] (grouped logically)
4. **From Research**: PydanticAI patterns → 4 integration tasks (sequential, same file)
5. **Ordering**: Setup → Tests → Models → Integration → Validation → Documentation

## Validation Checklist
- [x] All 3 contracts have corresponding test tasks (T004-T006)
- [x] All 5 enhanced entities have model tasks (T011-T015)
- [x] All tests come before implementation (T004-T010 before T011+)
- [x] Parallel tasks are truly independent (different files/sections)
- [x] Each task specifies exact file path and line numbers where applicable
- [x] No [P] task modifies same file section as another [P] task
- [x] Constitutional compliance maintained throughout
- [x] Backward compatibility preserved in all tasks
