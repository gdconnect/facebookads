{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Customer Journey Mapper Output (Agent Envelope)",
  "type": "object",
  "required": ["meta", "input", "output"],
  "properties": {
    "meta": {
      "type": "object",
      "description": "Agent execution metadata",
      "required": ["agent", "version", "trace_id", "ts", "brand_token", "hash", "cost"],
      "properties": {
        "agent": {
          "type": "string",
          "const": "customer_journey_mapper"
        },
        "version": {
          "type": "string",
          "pattern": "^\\d+\\.\\d+\\.\\d+$",
          "description": "SemVer version of the agent"
        },
        "trace_id": {
          "type": "string",
          "description": "Unique execution identifier"
        },
        "ts": {
          "type": "string",
          "format": "date-time",
          "description": "ISO-8601 execution timestamp"
        },
        "brand_token": {
          "type": "string",
          "description": "Brand configuration token used"
        },
        "hash": {
          "type": "string",
          "pattern": "^[a-f0-9]{64}$",
          "description": "SHA256 hash of the output"
        },
        "cost": {
          "type": "object",
          "required": ["tokens_in", "tokens_out", "usd"],
          "properties": {
            "tokens_in": {"type": "integer", "minimum": 0},
            "tokens_out": {"type": "integer", "minimum": 0},
            "usd": {"type": "number", "minimum": 0}
          }
        },
        "prompt_id": {
          "type": "string",
          "description": "Prompt identifier if LLM was used"
        },
        "prompt_hash": {
          "type": "string",
          "pattern": "^[a-f0-9]{64}$",
          "description": "SHA256 hash of the prompt if LLM was used"
        }
      }
    },
    "input": {
      "$ref": "schema.input.json",
      "description": "Original input that was processed"
    },
    "output": {
      "$ref": "../../../schemas/customer_journey.json.schema",
      "description": "Generated customer journey map conforming to the schema"
    },
    "error": {
      "type": ["string", "null"],
      "description": "Error message if processing failed, null if successful"
    }
  },
  "additionalProperties": false
}